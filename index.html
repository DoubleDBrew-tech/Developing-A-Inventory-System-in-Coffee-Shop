<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Simple Inventory System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background: #f5f5f5;
    }
    .nav-top {
        background: #ffffff;
        padding: 10px 20px;
        border-bottom: 1px solid #ddd;
    }
    .stock-red { color: #d9534f; font-weight: bold; }
    .stock-yellow { color: #f0ad4e; font-weight: bold; }
    .stock-green { color: #5cb85c; font-weight: bold; }
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="container mt-5" style="max-width:400px;">
    <h3 class="text-center mb-3">Inventory Login</h3>

    <div class="card p-3">
        <label>Email</label>
        <input type="email" id="email" class="form-control mb-2">

        <label>Password</label>
        <input type="password" id="password" class="form-control mb-3">

        <button class="btn btn-primary w-100" onclick="login()">Login</button>
    </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;">

    <!-- Top Nav -->
    <div class="nav-top d-flex justify-content-between align-items-center">
        <h4 class="m-0">Inventory</h4>

        <div>
            <button class="btn btn-outline-secondary btn-sm me-2" onclick="exportCSV()">Export CSV</button>
            <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container mt-4">

        <!-- ACTIONS -->
        <div class="mb-3 d-flex justify-content-between">
            <button class="btn btn-primary" onclick="openAddModal()">Add Product</button>

            <input type="text" id="searchBox" class="form-control w-25" placeholder="Search..." onkeyup="renderProducts()">
        </div>

        <!-- PRODUCT TABLE -->
        <table class="table table-bordered bg-white">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Stock</th>
                    <th>Price</th>
                    <th width="180">Actions</th>
                </tr>
            </thead>
            <tbody id="productBody"></tbody>
        </table>
    </div>
</div>

<!-- MODAL: ADD / EDIT -->
<div class="modal fade" id="productModal">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="modalTitle"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="pid">

        <label>Name</label>
        <input id="pname" class="form-control mb-2">

        <label>Price</label>
        <input id="pprice" type="number" class="form-control mb-2">

        <label>Stock</label>
        <input id="pstock" type="number" class="form-control mb-2">
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="saveProduct()">Save</button>
      </div>

    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js"></script>

<script>
/* ---------------------- FIREBASE SETUP ------------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyA-nzm4JKM6QdwVxcVu6uWUeRy9n5hJZpU",
  authDomain: "inventory-system-67e2e.firebaseapp.com",
  projectId: "inventory-system-67e2e",
  storageBucket: "inventory-system-67e2e.firebasestorage.app",
  messagingSenderId: "38184157713",
  appId: "1:38184157713:web:2a46fee4490e897954a7b0"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

/* ---------------------- LOGIN LOGIC ------------------------ */
function login() {
    let email = document.getElementById("email").value;
    let pass = document.getElementById("password").value;

    auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
            loginScreen.style.display = "none";
            app.style.display = "block";
            loadProducts();
        })
        .catch(err => alert(err.message));
}

function logout() {
    auth.signOut().then(() => {
        app.style.display = "none";
        loginScreen.style.display = "block";
    });
}

/* ---------------------- LOAD PRODUCTS ------------------------ */
let products = [];
async function loadProducts() {
    const snap = await db.collection("products").get();
    products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderProducts();
}

/* STOCK COLOR */
function colorize(stock) {
    if (stock <= 3) return "stock-red";
    if (stock <= 7) return "stock-yellow";
    return "stock-green";
}

/* ---------------------- RENDER TABLE ------------------------ */
function renderProducts() {
    const body = document.getElementById("productBody");
    let search = document.getElementById("searchBox").value.toLowerCase();

    body.innerHTML = "";

    products
        .filter(p => p.name.toLowerCase().includes(search))
        .forEach(p => {
            body.innerHTML += `
                <tr>
                    <td>${p.name}</td>
                    <td class="${colorize(p.stock)}">${p.stock}</td>
                    <td>â‚±${p.price.toFixed(2)}</td>

                    <td>
                        <button class="btn btn-sm btn-success me-1" onclick="adjust('${p.id}', 1)">+1</button>
                        <button class="btn btn-sm btn-warning me-1" onclick="adjust('${p.id}', -1)">-1</button>
                        <button class="btn btn-sm btn-primary" onclick="openEditModal('${p.id}')">Edit</button>
                    </td>
                </tr>
            `;
        });
}

/* ---------------------- ADJUST STOCK ------------------------ */
async function adjust(id, amount) {
    const ref = db.collection("products").doc(id);
    const doc = await ref.get();
    let stock = doc.data().stock + amount;
    if (stock < 0) stock = 0;

    await ref.update({ stock });
    loadProducts();
}

/* ---------------------- ADD PRODUCT MODAL ------------------------ */
function openAddModal() {
    document.getElementById("modalTitle").innerText = "Add Product";
    document.getElementById("pid").value = "";
    pname.value = "";
    pprice.value = "";
    pstock.value = "";
    new bootstrap.Modal(productModal).show();
}

/* ---------------------- EDIT PRODUCT MODAL ------------------------ */
function openEditModal(id) {
    let p = products.find(x => x.id === id);

    modalTitle.innerText = "Edit Product";
    pid.value = id;
    pname.value = p.name;
    pprice.value = p.price;
    pstock.value = p.stock;

    new bootstrap.Modal(productModal).show();
}

/* ---------------------- SAVE PRODUCT ------------------------ */
async function saveProduct() {
    let id = pid.value;
    let data = {
        name: pname.value,
        price: Number(pprice.value),
        stock: Number(pstock.value)
    };

    if (id === "") {
        await db.collection("products").add(data);
    } else {
        await db.collection("products").doc(id).update(data);
    }

    bootstrap.Modal.getInstance(productModal).hide();
    loadProducts();
}

/* ---------------------- EXPORT CSV ------------------------ */
function exportCSV() {
    let csv = "Name,Price,Stock\n";

    products.forEach(p => {
        csv += `${p.name},${p.price},${p.stock}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "inventory_export.csv";
    a.click();

    URL.revokeObjectURL(url);
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
</body>
</html>
